<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Story Visual Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family: system-ui, sans-serif;
}
#container{
  max-width:600px;
  margin:auto;
  padding:10px;
}
#visualBox{
  position:relative;
  width:100%;
  height:320px;
  background:#111;
  border-radius:14px;
  overflow:hidden;
}
#visualBox img,
#visualBox video{
  width:100%;
  height:100%;
  object-fit:cover;
  display:none;
}
#caption{
  margin-top:12px;
  font-size:20px;
  text-align:center;
  line-height:1.4;
}
textarea{
  width:100%;
  height:160px;
  margin-top:10px;
  border-radius:10px;
  padding:10px;
  font-size:16px;
}
button{
  width:100%;
  margin-top:10px;
  padding:12px;
  font-size:18px;
  border:none;
  border-radius:10px;
  background:#ff0055;
  color:#fff;
}
select{
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:10px;
  font-size:16px;
}
</style>
</head>

<body>
<div id="container">

<div id="visualBox">
  <img id="visualImg">
  <video id="visualVideo" autoplay muted loop playsinline></video>
</div>

<div id="caption">Script play karne ke liye Play dabaye</div>

<select id="mode">
  <option value="long">Long Video</option>
  <option value="short">Short Video</option>
</select>

<textarea id="scriptInput">
1Ô∏è‚É£ ‡§è‡§ï ‡§õ‡•ã‡§ü‡•á ‡§∏‡•á ‡§ó‡§æ‡§Å‡§µ ‡§Æ‡•á‡§Ç ‡§∞‡§æ‡§Æ‡•Ç ‡§®‡§æ‡§Æ ‡§ï‡§æ ‡§è‡§ï ‡§ó‡§∞‡•Ä‡§¨ ‡§≤‡§°‡§º‡§ï‡§æ ‡§∞‡§π‡§§‡§æ ‡§•‡§æ üè°
2Ô∏è‚É£ ‡§µ‡§π ‡§¨‡§π‡•Å‡§§ ‡§Æ‡•á‡§π‡§®‡§§‡•Ä ‡§•‡§æ üí™
3Ô∏è‚É£ ‡§è‡§ï ‡§¶‡§ø‡§® ‡§â‡§∏‡§ï‡•Ä ‡§ï‡§ø‡§∏‡•ç‡§Æ‡§§ ‡§¨‡§¶‡§≤‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§•‡•Ä ‚ú®
</textarea>

<button onclick="startPlay()">‚ñ∂ Play</button>

</div>

<script>
const PIXABAY_KEY = "54255969-e91e54d4235ef4c9b25009a63";
let lines = [];
let index = 0;
let wakeLock = null;
let lastKeyword = "";

function cleanForVoice(text){
  return text.replace(/[\u{1F300}-\u{1FAFF}\u{1F600}-\u{1F64F}]/gu,"");
}

function extractKeyword(line){
  return line
    .replace(/[\u{1F300}-\u{1FAFF}\u{1F600}-\u{1F64F}]/gu,"")
    .replace(/[0-9Ô∏è‚É£]/g,"")
    .split(/\s+/)
    .find(w => w.length > 2) || "";
}

async function fetchVisual(keyword){
  if(!keyword || keyword===lastKeyword) return;
  lastKeyword = keyword;

  try{
    let v = await fetch(`https://pixabay.com/api/videos/?key=${PIXABAY_KEY}&q=${encodeURIComponent(keyword)}&per_page=1&safesearch=true`);
    let vd = await v.json();
    if(vd.hits.length){
      showVideo(vd.hits[0].videos.medium.url);
      return;
    }

    let i = await fetch(`https://pixabay.com/api/?key=${PIXABAY_KEY}&q=${encodeURIComponent(keyword)}&image_type=photo&safesearch=true`);
    let id = await i.json();
    if(id.hits.length){
      showImage(id.hits[0].webformatURL);
    }
  }catch(e){}
}

function showImage(src){
  const img=document.getElementById("visualImg");
  const vid=document.getElementById("visualVideo");
  vid.pause();
  vid.style.display="none";
  img.src=src;
  img.style.display="block";
}

function showVideo(src){
  const img=document.getElementById("visualImg");
  const vid=document.getElementById("visualVideo");
  img.style.display="none";
  vid.src=src;
  vid.load();
  vid.play();
  vid.style.display="block";
}

async function lockScreen(){
  if("wakeLock" in navigator){
    wakeLock = await navigator.wakeLock.request("screen");
  }
}

function speakLine(text){
  const u = new SpeechSynthesisUtterance(cleanForVoice(text));
  u.lang="hi-IN";
  speechSynthesis.speak(u);
}

function playNext(){
  if(index>=lines.length) return;

  const line = lines[index];
  document.getElementById("caption").innerText = line;

  fetchVisual(extractKeyword(line));
  speakLine(line);

  index++;
  setTimeout(playNext, 3500);
}

function startPlay(){
  speechSynthesis.cancel();
  index=0;
  lastKeyword="";

  lines = document.getElementById("scriptInput").value
    .split("\n")
    .filter(l=>l.trim());

  if(document.getElementById("mode").value==="short"){
    lines = lines.slice(0,5);
  }

  lockScreen();
  playNext();
}
</script>
</body>
</html>
